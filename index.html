<html>
	<head>
	<title>Hanging plotter simulator</title>
	<style>
	#wrapper {
	  margin-left: 350px;
	}
	#content {
	  float: left;
	  width: 100%;
	}
	#sidebar {
	  float: left;
	  width: 300px;
	  margin-left: -350px;
	}
	#cleared {
	  clear: both;
	}
	</style>	  
	</head>
	<body>
    <div id="wrapper">
        <div  id="content" style="position: relative;">
         <canvas id="canvas" width="650" height="600" 
           style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
         <canvas id="drawinglayer" width="650" height="600" 
           style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
        </div>   
		<div id="sidebar">GCode:</br></br>
			<textarea id="gcode" rows="40" cols="40">
G17
G90
G0 Z10
G0 X0 Y0
M3
G4 P2000.000000
G00 Z10
G00 X3.5278 Y111.1250
G01 Z0 F10.00
G01 X38.8056 Y75.8472
G03 X37.2516 Y67.9193 I25.0997 J-9.0359
G03 X38.1271 Y59.5249 I29.0896 J-1.2092
G03 X40.0621 Y54.4671 I22.6638 J5.7716
G03 X42.5133 Y51.1293 I12.1220 J6.3330
G03 X47.7678 Y48.7782 I5.7064 J5.7064
G01 X53.0036 Y50.5409
G01 X55.3108 Y53.1833
G01 X57.3440 Y57.3087
G01 X60.8718 Y53.7810
G03 X58.3431 Y50.9025 I20.9860 J-20.9860
G03 X56.3575 Y47.9186 I20.5769 J-15.8452
G03 X55.2132 Y45.6318 I20.5261 J-11.7006
G03 X54.4265 Y43.4735 I17.4869 J-7.5964
G03 X53.9544 Y41.4233 I16.0310 J-4.7708
G03 X53.7891 Y39.6066 I12.4061 J-2.0451
G03 X54.3510 Y36.1669 I9.7268 J-0.1768
G03 X55.8682 Y33.7667 I6.0832 J2.1658
G03 X57.7236 Y32.4732 I4.5524 J4.5524
G03 X60.2108 Y31.7633 I3.5272 J7.6454
G03 X62.7356 Y31.7489 I1.3230 J10.6290
G01 X65.8040 Y32.3948
G01 X70.8042 Y34.7079
G01 X75.8825 Y38.7703
G01 X111.1250 Y3.5278
G0 Z10
M5
M2

			</textarea>
			</br>
			<input type="button" value="Run" onClick="runGCode();">
		</div>
		<div id="cleared"></div>
	</div>  
    </body>
    <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="Box2d.min.js"></script>
    <script type="text/javascript" src="Queue.js"></script>
	<script type="text/javascript" src="gcode.js"></script>
	<script type="text/javascript" src="engine.js"></script>
    <script type="text/javascript" src="interpreter.js"></script>
    <script type="text/javascript">

var movements = new Queue();

var world;
var ctx;
var drawingctx;

// box2d to canvas scale: 1 metre in box2d = 600px of canvas
var scale = 600;

// frame per sec for the world
var fps = 60;

// distance between the two motors
d = m(1)-cm(6);

// the actual drawing area in the world
var bbox = {x: cm(10), y: cm(10), width: cm(80)-suspensionMargin, height: cm(80)-suspensionMargin};

// lengths for home position
var il1 = length1(0,0);
var il2 = length2(0,0);
 
function length1(x,y)
{
    x += bbox.x-suspensionMargin;
    y += bbox.y-suspensionMargin;
    return Math.sqrt((x*x) + (y*y));
}

function length2(x,y)
{
    x += bbox.x-suspensionMargin;
    y += bbox.y-suspensionMargin;
    return Math.sqrt(((d-x)*(d-x)) + (y*y));
}

// Coordinate transformation
function toLengths(points)
{
    movements = new Queue();
    
    var cl1 = il1;
    var cl2 = il2;

    for(var i=0; i<points.length; i++)
    {
        // Points are in mm, convert them to meter as box2d likes
        var x = mm(points[i].x);
        var y = mm(points[i].y);

        var l1 = length1(x,y);
        var l2 = length2(x,y);
        
        movements.enqueue({l1: l1-cl1, l2: l2-cl2, drawing: points[i].drawing});
        
        cl1 = l1;
        cl2 = l2;
    }
}

function step() 
{
    var timeStep = 1.0/(fps * 0.8);
     
    var m; 
    var sposx = nozzle.GetPosition().x;
    var sposy = nozzle.GetPosition().y;
	
    if(!movements.isEmpty())
    {
        m = movements.dequeue();
        distance_joint1.SetLength(distance_joint1.GetLength() + m.l1);
        distance_joint2.SetLength(distance_joint2.GetLength() + m.l2);
    }	 
	 
    //move the box2d world ahead
    world.Step(timeStep , 8 , 3);
    world.ClearForces();
     
    //redraw the world
	world.DrawDebugData();
        
    if(m && m.drawing)
    {
        var pos = nozzle.GetPosition();
		
        drawingctx.beginPath();
		drawingctx.moveTo(sposx, sposy);
        drawingctx.lineTo(pos.x, pos.y);
		drawingctx.strokeStyle = "black"; 
        drawingctx.stroke(); 
    }
        
    //call this function again after 1/60 seconds or 16.7ms
    setTimeout(step , 1000 / fps);
}  

function runGCode()
{
    var text = document.getElementById("gcode").value;
    var gcodes = parseGCode(text);
    
    // go home a the end
    gcodes.push({type: 'G0', args: {X:0,Y:0}});
    gcodes.push({type: 'G0', args: {Z:0}});
    
    var inter = new interpreter(gcodes, 0.5); // resolution is 0.5 mm
    var points = inter.toPoints();
    toLengths(points);
}
  
// main entry point
$(function() 
{
    //first create the world
    world = createWorld(scale,bbox.x,bbox.y,il1,il2);
     
    var canvas = $('#canvas');
    ctx = canvas.get(0).getContext('2d');

    var drawingcanvas = $('#drawinglayer');
    drawingctx = drawingcanvas.get(0).getContext('2d');
    drawingctx.scale(scale,scale);
	drawingctx.lineWidth=mm(1);
	
	drawingctx.beginPath();
	drawingctx.rect(bbox.x, bbox.y, bbox.width, bbox.height);
	drawingctx.strokeStyle = "black";
	drawingctx.stroke();  	
	          
    //start stepping
    step();
});
   
   </script>
   
   
</html>