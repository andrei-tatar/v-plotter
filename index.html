<html>
	<head>
	<title>Hanging plotter simulator</title>
	<style>
	#wrapper {
	  margin-left: 350px;
	}
	#content {
	  float: left;
	  width: 100%;
	}
	#sidebar {
	  float: left;
	  width: 300px;
	  margin-left: -350px;
	}
	#cleared {
	  clear: both;
	}
	</style>	  
	</head>
	<body>
    <div id="wrapper">
        <div  id="content" style="position: relative;">
         <canvas id="canvas" width="650" height="600" 
           style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
         <canvas id="drawinglayer" width="650" height="600" 
           style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
        </div>   
		<div id="sidebar">GCode:</br></br>
			<textarea id="gcode" rows="40" cols="40">
G17
G90
G0 Z10
G0 X0 Y0
M3
G4 P2000.000000
G00 Z10
G00 X35.278 Y35.278
G01 Z0 F10.00
G01 X388.056 Y35.278
G01 X388.056 Y388.056
G01 X35.278 Y388.056
G01 X35.278 Y35.278
G0 Z10
M5
M2
			</textarea>
			</br>
			<input type="button" value="Run" onClick="runGCode();">
		</div>
		<div id="cleared"></div>
	</div>  
    </body>
    <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="Box2d.min.js"></script>
    <script type="text/javascript" src="Queue.js"></script>
	<script type="text/javascript" src="gcode.js"></script>
	<script type="text/javascript" src="engine.js"></script>
    <script type="text/javascript" src="interpreter.js"></script>
    <script type="text/javascript">

var movements = new Queue();

var world;
var ctx;
var drawingctx;

// box2d to canvas scale: 1 metre in box2d = 600px of canvas
var scale = 600;

// frame per sec for the world
var fps = 60;

// distance between the two motors
d = m(1)-cm(6);

// the actual drawing area in the world
var bbox = {x: cm(10), y: cm(10), width: cm(80)-suspensionMargin, height: cm(80)-suspensionMargin};

// lengths for home position
var il1 = length1(0,0);
var il2 = length2(0,0);
 
function length1(x,y)
{
    x += bbox.x-suspensionMargin;
    y += bbox.y-suspensionMargin;
    return Math.sqrt((x*x) + (y*y));
}

function length2(x,y)
{
    x += bbox.x-suspensionMargin;
    y += bbox.y-suspensionMargin;
    return Math.sqrt(((d-x)*(d-x)) + (y*y));
}

// Coordinate transformation
function toLengths(points)
{
    movements = new Queue();
    
    var cl1 = il1;
    var cl2 = il2;

    for(var i=0; i<points.length; i++)
    {
        // Points are in mm, convert them to meter as box2d likes
        var x = mm(points[i].x);
        var y = mm(points[i].y);

        var l1 = length1(x,y);
        var l2 = length2(x,y);
        
        movements.enqueue({l1: l1-cl1, l2: l2-cl2, drawing: points[i].drawing});
        
        cl1 = l1;
        cl2 = l2;
    }
}

function step() 
{
    var timeStep = 1.0/(fps * 0.8);
     
    var m; 
    var sposx = nozzle.GetPosition().x;
    var sposy = nozzle.GetPosition().y;
	
    if(!movements.isEmpty())
    {
        m = movements.dequeue();
        distance_joint1.SetLength(distance_joint1.GetLength() + m.l1);
        distance_joint2.SetLength(distance_joint2.GetLength() + m.l2);
    }	 
	 
    //move the box2d world ahead
    world.Step(timeStep , 8 , 3);
    world.ClearForces();
     
    //redraw the world
	world.DrawDebugData();
        
    if(m && m.drawing)
    {
        var pos = nozzle.GetPosition();
		
        drawingctx.beginPath();
		drawingctx.moveTo(sposx, sposy);
        drawingctx.lineTo(pos.x, pos.y);
		drawingctx.strokeStyle = "black"; 
        drawingctx.stroke(); 
    }
        
    //call this function again after 1/60 seconds or 16.7ms
    setTimeout(step , 1000 / fps);
}  

function runGCode()
{
    var text = document.getElementById("gcode").value;
    var gcodes = parseGCode(text);
    
    // go home a the end
    gcodes.push({type: 'G0', args: {X:0,Y:0}});
    gcodes.push({type: 'G0', args: {Z:0}});
    
    var inter = new interpreter(gcodes, 0.5); // resolution is 0.5 mm
    var points = inter.toPoints();
    toLengths(points);
}
  
// main entry point
$(function() 
{
    //first create the world
    world = createWorld(scale,bbox.x,bbox.y,il1,il2);
     
    var canvas = $('#canvas');
    ctx = canvas.get(0).getContext('2d');

    var drawingcanvas = $('#drawinglayer');
    drawingctx = drawingcanvas.get(0).getContext('2d');
    drawingctx.scale(scale,scale);
	drawingctx.lineWidth=mm(1);
	
	drawingctx.beginPath();
	drawingctx.rect(bbox.x, bbox.y, bbox.width, bbox.height);
	drawingctx.strokeStyle = "black";
	drawingctx.stroke();  	
	          
    //start stepping
    step();
});
   
   </script>
   
   
</html>